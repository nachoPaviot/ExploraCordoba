{% extends "base.html" %}

{% block head %}
    {{ super() }} 
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        #mapa {
            height: 500px;
            width: 100%;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row align-items-center mb-4">
        
        <div class="col-md-9">
            <h1 class="page-title">Visualización de Destinos en el Mapa</h1>
            <p>Explora la ubicación de nuestros destinos de turismo alternativo en Córdoba.</p>
        </div>
        
        <div class="col-md-3 text-end">
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                ← Volver al Inicio
            </a>
        </div>
    </div>
    <hr>

    <div id="mapa" class="shadow"></div>

</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const DESTINO_URL_BASE = "{{ url_for('main.destino_detalle', destino_id=99999).replace('99999', '') }}";
    // Inyectar la variable 'destinos' y corregir el parseo 
    const destinos_json_str = '{{ destinos | tojson | safe }}'; 
    let destinos_data = [];

    try {
        destinos_data = JSON.parse(destinos_json_str);
    } catch (e) {
        console.error("Error al parsear datos de destinos:", e);
    }

    // Coordenadas centrales de la provincia de Córdoba
    const LAT_CORDOBA = -31.3962;
    const LON_CORDOBA = -64.1873;

    // 1. Inicializar el mapa
    const mapa = L.map('mapa').setView([LAT_CORDOBA, LON_CORDOBA], 9); 

    // 2. Agregar los "tiles" (imágenes del mapa) de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(mapa);

    // 3. Colocar marcadores en el mapa
    destinos_data.forEach(destino => {
        let lat = null;
        let lon = null;
        const detalleUrl = DESTINO_URL_BASE + destino.destino_id;

        if (destino.coordenadas && typeof destino.coordenadas === 'string') {
            const coords = destino.coordenadas.split(',');
            lat = parseFloat(coords[0]);
            lon = parseFloat(coords[1]);
        } 
        
        if (lat && lon && !isNaN(lat) && !isNaN(lon)) {
            // Construir la URL completa para el detalle de este destino
            const detalleUrl = DESTINO_URL_BASE + destino.destino_id;

            // Contenido HTML del popup, incluyendo el enlace
            const popupContent = `
                <b>${destino.nombre}</b><br>
                ${destino.descripcion || 'Sin descripción'}<br>
                <a href="${detalleUrl}">Ver Servicios →</a>
            `;


            L.marker([lat, lon])
            .addTo(mapa)
            .bindPopup(popupContent)
            .on('click', function (e) {
                // Abre el popup automáticamente al hacer clic en el marcador
                e.target.openPopup();
            });
        } else {
            console.warn(`Destino '${destino.nombre}' omitido: Coordenadas no válidas o faltantes.`);
        }
    });
</script>

{% endblock content %}
{% extends "base.html" %}

{% macro render_posteos(posteos_list) %}
    {% for post in posteos_list %}
        <div class="card mb-3 {% if post.posteo_padre_id %}ms-5 border-start border-secondary border-2{% endif %} post-card">
            <div class="card-body">
                {% if post.titulo and not post.posteo_padre_id %}
                    <h5 class="card-title">{{ post.titulo }}</h5>
                {% endif %}

                <p class="card-text">{{ post.contenido }}</p>

                <footer class="blockquote-footer mt-2">
                    Publicado por 
                    <cite title="Autor">{{ post.autor.nombre }} {{ post.autor.apellido }}</cite> 
                    el {{ post.fecha_creacion.strftime('%d/%m/%Y %H:%M') }}
                    {% if post.posteo_padre_id %} (Respuesta){% endif %}
                </footer>
                
                <div class="mt-2 d-flex justify-content-end align-items-center">
                    
                    {% if current_user.is_authenticated %}
                    <button type="button" 
                            class="btn btn-sm btn-link text-decoration-none me-auto btn-reply" 
                            data-parent-id="{{ post.posteo_id }}"
                            data-parent-author="{{ post.autor.nombre }}">
                        Responder
                    </button>
                    {% endif %}
                    
                    {% if current_user.usuario_id == post.usuario_id %}
                        <a href="{{ url_for('main.editar_posteo', posteo_id=post.posteo_id) }}" 
                            class="btn btn-info btn-sm me-2">
                            Editar
                        </a>
                    {% endif %}
                    {% if current_user.usuario_id == post.usuario_id or current_user.rol_id in [1, 2] %}
                        <form action="{{ url_for('main.eliminar_posteo', posteo_id=post.posteo_id) }}" method="POST" style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-sm" 
                                    onclick="return confirm('¬øEst√°s seguro de eliminar este comentario?');">
                                Eliminar
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
            
            {% if post.replies.all() %}
                <div class="px-3 pt-2">
                    {{ render_posteos(post.replies.all()) }}
                </div>
            {% endif %}
        </div>
    {% endfor %}
{% endmacro %}

{% block content %}
<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Foro de Viajeros üí¨</h2>
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
            ‚Üê Volver al Inicio
        </a>
    </div>
    <hr>

    <h3 class="mb-3">Comentarios Recientes</h3>
    
    {% if posteos %}
        {{ render_posteos(posteos) }}
    {% else %}
        <div class="alert alert-info text-center py-4"></div>
            A√∫n no hay comentarios en el foro. ¬°Publica vos primero!
        </div>
    {% endif %}

    <hr class="mt-5 mb-4">

    {% if current_user.is_authenticated and current_user.rol_id == 5 %}
    <h3 class="mb-3">¬øQueres compartir algo?</h3>

    <div class="card mb-4 shadow-sm" id="reply-form-card">
        <div class="card-header bg-primary text-white" id="form-header">
            Publicar un nuevo comentario
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('main.foro') }}" id="comment_form">
                
                <input type="hidden" name="parent_id" id="parent_id_input" value="">

                <div class="form-group mb-3" id="titulo-group">
                    <input type="text" class="form-control" name="titulo" id="titulo-input" placeholder="T√≠tulo" maxlength="150">
                </div>
                <div class="form-group">
                    <textarea class="form-control" name="contenido" id="contenido-input" rows="3" placeholder="Escrib√≠ tu comentario o respuesta aca..." required></textarea>
                </div>
                
                <div class="d-flex justify-content-between mt-3">
                    <button type="submit" class="btn btn-primary">Publicar</button>
                    <button type="button" class="btn btn-outline-secondary d-none" id="cancel_reply">
                        Cancelar Respuesta
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
            ‚Üê Volver al Inicio
        </a>
</div>
{% endblock %}


{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const parentIdInput = document.getElementById('parent_id_input');
        const contentInput = document.getElementById('contenido-input');
        const tituloInputGroup = document.getElementById('titulo-group');
        const formHeader = document.getElementById('form-header');
        const cancelReplyButton = document.getElementById('cancel_reply');

        function resetFormToNewPost() {
            parentIdInput.value = '';
            contentInput.value = '';
            formHeader.textContent = 'Publicar un nuevo comentario';
            cancelReplyButton.classList.add('d-none');
            tituloInputGroup.style.display = 'block'; 
        }
        
        document.querySelectorAll('.btn-reply').forEach(button => {
            button.addEventListener('click', function() {
                const parentId = this.dataset.parentId;
                const parentAuthor = this.dataset.parentAuthor;
                
                // Configurar el formulario para la respuesta
                parentIdInput.value = parentId;
                contentInput.value = `@${parentAuthor} `;
                
                // indica que se est√° respondiendo
                formHeader.textContent = `Respondiendo a ${parentAuthor}`;
                cancelReplyButton.classList.remove('d-none');
                tituloInputGroup.style.display = 'none';
                
                contentInput.focus();
                document.getElementById('reply-form-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        });
        
        cancelReplyButton.addEventListener('click', resetFormToNewPost); 
          
        resetFormToNewPost();
    });
</script>
{% endblock %}